# CFST-Extractor 实施计划

> 最后更新: 2026-02-15

---

## 1. 项目概述

### 1.1 目标

cfst-extractor 是一个自动化的数据提取管道，用于从钢管混凝土 (CFST) 研究论文 PDF 中提取试验数据。管道将论文解析为结构化的 JSON 数据，包含论文元数据、试件几何参数、材料属性和试验极限承载力。

### 1.2 核心价值

- **自动化**: 将人工数小时/篇的提取工作压缩到分钟级别
- **标准化**: 统一输出 schema，消除人为标注差异
- **可追溯**: 每个数据点附带 source_evidence，支持回查验证

### 1.3 架构设计 — 混合 GPU/CPU 双阶段

```
┌──────────────────────────────┐      ┌──────────────────────────────────────────┐
│  阶段 A: Colab GPU 解析       │      │  阶段 B: 本地 CPU 提取                     │
│                              │      │                                          │
│  PDF ──→ MinerU v2.7+ (mineru)  │ ──→  │  MinerU JSON ──→ Pipeline ──→ 结构化 JSON │
│    · GPU 加速布局检测          │      │    · 表头同义词匹配                        │
│    · 表格 HTML 提取           │      │    · 单位检测与转换                        │
│    · 跨页表格合并             │ sync  │    · 跨表融合                             │
│    · Markdown 全文输出        │      │    · 分组分类                             │
│                              │      │    · 验证与置信度打分                      │
│  Google Drive 存储            │      │    · JSON 输出                            │
└──────────────────────────────┘      └──────────────────────────────────────────┘
```

### 1.4 管道阶段

| 阶段 | 名称 | 文件 | 状态 |
|------|------|------|------|
| S1 | Ingestion (PDF摄入) | `stages/s1_ingestion.py` | 已完成（当前入口为已解析目录时不执行） |
| S2 | Parse (MinerU输出读取) | `parsers/mineru_reader.py` | 已完成 |
| S2b | Metadata (GROBID元数据) | `parsers/grobid_client.py` | 已完成 |
| S3 | Validity (有效性筛查) | `stages/s3_validity.py` | 已完成 |
| S4 | Table Extraction (表头映射) | `stages/s4_table_extraction.py` | 已完成 |
| S5 | Normalization (语义归一化) | `stages/s5_normalization.py` | 已完成 |
| S6 | LLM Enrichment (LLM增强) | 尚未实现 | Phase IV |
| S7 | Validation (验证打分) | `stages/s7_validation.py` | 已完成 |
| S8 | Output (JSON输出) | `stages/s8_output.py` | 已完成 |

---

## 2. 技术栈

### 2.1 PDF 解析层

| 工具 | 角色 | 部署位置 |
|------|------|----------|
| **MinerU v2.7+ (`mineru`)** | 主力解析器 — 版面分析、表格识别、公式识别、Markdown 生成 | Colab GPU |
| **GROBID** | 学术论文元数据提取 (title, authors, journal, year) | 本地 Docker (`localhost:8070`) |
| **pdfplumber** | PDF 类型检测 (native/scanned)、备用表格提取 | 本地 CPU |

### 2.2 数据处理层

| 工具 | 角色 |
|------|------|
| **Pydantic v2** | 输出 schema 定义、字段验证、自动四舍五入 |
| **pandas** | DataFrame 操作 — 表格解析、行列操作、多表融合 |
| **Pint** | 物理单位转换 (N→kN, cm→mm, N/mm²→MPa 等) |
| **thefuzz (python-Levenshtein)** | 表头模糊匹配 — 处理 OCR 错误和非标准表头 |
| **BeautifulSoup + lxml** | HTML 表格解析 (MinerU 输出的表格 HTML) |
| **structlog** | 结构化日志 — JSON 格式，方便调试和追溯 |

### 2.3 知识库

```
src/cfst_extractor/knowledge/
├── synonyms.py   # 15 个 schema 字段的 100+ 同义词映射
├── keywords.py   # 有效性筛查关键词 (CFST/实验/加载/拒绝)
├── units.py      # 单位检测正则、转换、合理范围
└── ranges.py     # 截面形状关键词、GROUP 规则、几何约束
```

---

## 3. 当前进度 (Phase I 已完成)

### 3.1 已完成模块

- 项目结构搭建: pyproject.toml, hatch 构建系统, ruff 代码风格
- CLI 框架: typer 三个子命令 (`single`, `batch`, `validate`)
- MinerU 输出读取器: content_list.json 解析, HTML→DataFrame
- GROBID 客户端: TEI XML 解析, 超时/连接错误优雅降级
- PDF 类型检测: native/scanned 分类, SHA-256 哈希
- 有效性筛查: 多维度评分, 硬拒绝规则
- 表头映射: 同义词精确匹配 + thefuzz 模糊匹配
- 语义归一化: 8 步归一化流程
- 验证打分: 必填字段检查, 范围合理性, 几何约束, 加权置信度
- JSON 输出: Group_A/B/C 分流, Pydantic 序列化
- Colab 笔记本: 单篇测试 + 批量解析, 使用 `mineru` v2.7+ (从 GitHub 源码安装, 模型自动下载)
- 8 项单元测试全部通过

### 3.2 已知限制

1. 表头映射未覆盖真实论文中所有变体
2. 跨表融合逻辑对复杂场景不完善
3. 分组检测未考虑同一论文中方形+圆形混合
4. fc_type 未提取
5. source_evidence 格式不够精细

---

## 4. Phase II — 核心提取逻辑

> **目标**: 在 3 个标准测试用例 (A1-3, A1-4, A1-5) 上达到 >90% 字段级准确率

### 4.1 MinerU 输出准备

- **4.1.1**: 在 Colab 上使用 `mineru` CLI (`mineru -p <pdf> -o <out> -m auto -b pipeline`) 解析 8 篇测试论文
- **4.1.2**: 将解析结果同步到本地 `testdata/parsed/`

### 4.2 表头同义词完善

- **4.2.1**: 分析测试论文实际表头, 扩展 `synonyms.py` 同义词覆盖
- **4.2.2**: 改进模糊匹配策略 (按表独立映射, 多行表头合并)

### 4.3 字段提取与复合列解析

- **4.3.1**: 扩展复合列解析 (`B×t`, `D/t`, `B×H×t`)
- **4.3.2**: 添加 fc_type 提取逻辑 (正文搜索 cube/cylinder/prism + 尺寸)

### 4.4 单位转换增强

- **4.4.1**: 扩展表头单位检测 (中文单位, ksi, GPa)
- **4.4.2**: 改进批量力单位推断 (结合截面面积交叉验证)

### 4.5 跨表融合

- **4.5.1**: 改进 specimen_label 匹配 (忽略大小写, 前缀差异, 模糊匹配)
- **4.5.2**: 支持非试件表的数据补充 (材料属性表, 结果对比表)

### 4.6 分组分类

- **4.6.1**: 支持同一论文中多截面形状 (逐试件分组)
- **4.6.2**: 完善 r0 计算规则

### 4.7 JSON 输出组装

- **4.7.1**: 完善 source_evidence 生成 (多来源聚合)

### 4.8 端到端测试

- **4.8.1**: 创建回归测试框架 `test_e2e_regression.py`
- **4.8.2**: 验收标准: A1-3/A1-4 准确率 >90%, A1-5 准确率 >80%

---

## 5. Phase III — 边缘案例与鲁棒性

> **目标**: 全部 8 个测试用例正确处理

### 5.1 无效论文拒绝

- **5.1.1**: 改进有效性筛查以正确拒绝 A1-12 (STCC节点/火灾论文)

### 5.2 偏心压缩处理

- **5.2.1**: 支持 A1-6 的双曲率弯曲 (e2 负值保留)
- **5.2.2**: 支持 A1-14 的轴压+偏压混合 (逐试件判断)

### 5.3 大规模试件论文

- **5.3.1**: 支持 A1-1 的 84 试件、双表、L 推算 (`Clear Height = 2B/2D`)

### 5.4 扫描 PDF 处理

- **5.4.1**: MinerU v2.7 内置 OCR 质量评估与后处理 (A1-5)

### 5.5 FEA 数据过滤

- **5.5.1**: 改进 FEA/计算值排除逻辑 (优先实验表, 排除 FEA 表)

### 5.6 验收标准

| 测试用例 | 验收条件 |
|----------|---------|
| A1-1 (Sakino) | Group_A=48, Group_B=36, 准确率 >85% |
| A1-2 (Schneider) | Group_A=11, Group_B=3, 准确率 >90% |
| A1-3 (Huang) | Group_A=14, Group_B=3, 准确率 >95% |
| A1-4 (李斌) | Group_B=12, 准确率 >95% |
| A1-5 (韩林海) | Group_B=22, 准确率 >85% |
| A1-6 (Zeghiche) | Group_B=30, e2 负号正确, 准确率 >90% |
| A1-12 (Han) | is_valid=false |
| A1-14 (谭克锋) | Group_B=20, e 值正确, 准确率 >90% |

---

## 6. Phase IV — 质量保障与人机协同

> **目标**: LLM 填补缺失字段, 建立人工审核流程

### 6.1 LLM 增强提取 (Stage 6)

- **6.1.1**: 实现 `s6_llm_enrichment.py` (fc_type 推断, 缺失值补全, L 推算)
- **6.1.2**: LLM 响应验证 (范围检查, 置信度降权, 审计日志)

### 6.2 置信度评分完善

- **6.2.1**: 多维置信度模型 (完整性×合理性×一致性×来源可靠性)
- **6.2.2**: 阈值路由固化: `>=0.85` 自动通过, `0.60~0.85` 抽检, `<0.60` 人工复核

### 6.3 人工审核队列

- **6.3.1**: HTML 审核报告生成 (高亮低置信度字段, LLM 填补标记)
- **6.3.2**: `cfst-extract review` CLI 子命令

---

## 7. Phase V — 批量处理与规模化

> **目标**: 支持 100+ 篇论文的高效批量处理

### 7.1 批量 CLI 增强

- 进度条, `--resume` 断点续传, `--filter` 模式筛选, `--dry-run`

### 7.2 缓存机制

- GROBID 结果缓存 (基于 PDF SHA-256)
- 管道结果缓存 (哈希 + 管道版本号)

### 7.3 批量报告

- 扩展 `batch_summary.json`, 可选 CSV 导出

### 7.4 性能优化

- IO 密集 (GROBID) 用 ThreadPoolExecutor, CPU 密集用 ProcessPoolExecutor

---

## 8. 测试策略

### 8.1 金标准回归测试

对比维度:
1. **is_valid**: 布尔值精确匹配
2. **group 分布**: 试件数精确匹配
3. **specimen_label 集合**: 集合相等
4. **数值字段**: 逐字段对比, tolerance = max(0.5%, 0.1)

### 8.2 KPI 目标

| 指标 | Phase II | Phase III | Phase IV |
|------|----------|-----------|----------|
| 有效性判断准确率 | 75% | 100% | 100% |
| 试件数完全正确率 | 43% | 86% | 100% |
| 字段级准确率 | >80% | >90% | >95% |
| 平均置信度 | >0.6 | >0.75 | >0.85 |

### 8.3 难度分级

| 等级 | 测试用例 | 难度因素 |
|------|---------|---------|
| Tier-1 | A1-3, A1-4 | 清晰表格, 标准表头 |
| Tier-2 | A1-2, A1-5, A1-14 | 单位转换, 中文, 混合加载 |
| Tier-3 | A1-1, A1-6, A1-12 | 大表, 双曲率, 无效论文 |

---

## 9. 已知风险与待解决问题

### 高风险

| 风险 | 缓解措施 |
|------|----------|
| 中文扫描 PDF OCR 质量 | 评估 MinerU v2.7 内置 OCR → OCR 后处理 → pdfplumber 备用 |
| 跨页表格 | MinerU v2.7 内置跨页合并 + 启发式合并 |
| L 值推算 | 正文正则 + LLM 辅助 + 标记缺失 |

### 中风险

| 风险 | 缓解措施 |
|------|----------|
| 复合列解析 | 扩展正则覆盖所有分隔符变体 |
| 表头歧义 ("D" 可能是直径或深度) | 结合截面类型上下文消歧 |
| 单位误判 | 多字段交叉验证 (fc×面积 ≈ n_exp) |
| 同一论文方圆混合 | 逐试件分组 |

### 待解决的技术问题

1. 多行表头合并: MinerU HTML 表格可能将合并表头拆分
2. r_ratio 提取: 需要更多同义词和正文模式
3. fc_value 的 f'c vs fcu 区分: 不同强度规格值可能差 20%
4. 试件编号格式不统一: "Specimen 1" vs "SC-1"

---

## 10. 附录: 测试用例矩阵

| ID | 论文 | 年份 | 语言 | 试件数 | Group_A | Group_B | is_valid | 关键挑战 |
|----|------|------|------|--------|---------|---------|----------|---------|
| A1-1 | Sakino et al. | 2004 | EN | 84 | 48 | 36 | true | 大表, L推算, 方圆混合 |
| A1-2 | Schneider | 1998 | EN | 14 | 11 | 3 | true | 英制单位, 三种截面 |
| A1-3 | Huang et al. | 2002 | EN | 17 | 14 | 3 | true | 多表融合, 加劲柱 |
| A1-4 | 李斌, 郝润霞 | 2005 | CN | 12 | 0 | 12 | true | 中文, 单表, 简单 |
| A1-5 | 韩林海 | 1997 | CN | 22 | 0 | 22 | true | 扫描件, 组均值 n_exp |
| A1-6 | Zeghiche, Chaoui | 2005 | EN | 30 | 0 | 30 | true | 偏压+双曲率 (负e2) |
| A1-12 | Han et al. | 2005 | EN | 0 | 0 | 0 | false | 无效论文 (节点/火灾) |
| A1-14 | 谭克锋, 蒲心诚 | 1999 | CN | 20 | 0 | 20 | true | 轴压+偏压混合, 3表融合 |

**总计**: 7 有效论文, 199 试件 (Group_A=73, Group_B=126), 4 英文 + 4 中文

---

## 11. 里程碑

| 里程碑 | 交付物 |
|--------|--------|
| Phase I (基础设施) | **已完成** — 管道骨架, 所有 stage 代码, 知识库, Colab 笔记本 (已迁移至 mineru v2.7+), 8项测试通过 |
| Phase II (核心提取) | A1-3/A1-4/A1-5 >90% 准确率, 回归测试框架 |
| Phase III (鲁棒性) | 8/8 测试用例正确, 含偏压/拒绝/扫描 |
| Phase IV (质量保障) | LLM 增强, 置信度评分, HTML 审核报告 |
| Phase V (规模化) | 缓存, 批量报告, 性能优化 |
